import{_ as w,c as x,a as s,e as q,g,t as p,F as b,f,o as _,w as v,i as T}from"./index-C23T03Zw.js";const k={name:"CustomerCenter",data(){return{currentUser:null,testGroups:[],ad8Groups:[],psqiGroups:[],expandedGroups:{}}},computed:{groupedTests(){const t={};return this.testGroups.forEach(e=>{t[e.testType]||(t[e.testType]=[]),t[e.testType].push(e)}),t},latestTestDate(){if(this.testGroups.length===0)return"无记录";const t=[...this.testGroups].sort((e,r)=>new Date(r.created_at)-new Date(e.created_at))[0];return`${t.testType} (${this.formatDate(t.created_at)})`},totalTests(){return this.testGroups.reduce((t,e)=>t+e.responses.length,0)}},created(){this.loadUserData(),this.fetchTestRecords()},methods:{toggleGroup(t){this.expandedGroups={...this.expandedGroups,[t]:!this.expandedGroups[t]}},loadUserData(){const t=localStorage.getItem("currentUser");this.currentUser=t?JSON.parse(t):null},async fetchTestRecords(){if(this.currentUser)try{const t="http://172.22.104.102:8080",e=`${t}/user/ad8_responses`,r=`${t}/user/psqi_responses`,l={hospitalId:this.currentUser.hospitalNumber,patientName:this.currentUser.name},o=localStorage.getItem("authToken"),n=o?{Authorization:`Bearer ${o}`}:{},u=`${e}?${new URLSearchParams(l)}`,a=`${r}?${new URLSearchParams(l)}`,[i,m]=await Promise.all([fetch(u,{headers:n}),fetch(a,{headers:n})]),y=await i.json(),C=await m.json();console.log("AD8 API Response:",y),console.log("PSQI API Response:",C),this.ad8Groups=y.success?y.data.map(d=>{var h;return{testId:((h=d.responses[0])==null?void 0:h.response_id)||"",testType:"AD8测试",testDate:d.created_at,score:d.responses.reduce((c,D)=>c+(D.selected_option||0),0),questionCount:d.responses.length,responses:d.responses.map(c=>({questionId:c.question_id,questionText:c.question_text,answer:c.answer_text,selectedOption:c.selected_option}))}}):[],this.psqiGroups=C.success?C.data.map(d=>{var h;return{testId:((h=d.responses[0])==null?void 0:h.response_id)||"",testType:"PSQI测试",testDate:d.created_at,score:d.responses.reduce((c,D)=>c+(D.option_value||0),0),questionCount:d.responses.length,responses:d.responses.map(c=>({questionId:c.question_id,questionText:c.question_text,answer:c.answer_text,optionValue:c.option_value}))}}):[],this.testGroups=[...this.ad8Groups,...this.psqiGroups].sort((d,h)=>new Date(h.created_at)-new Date(d.created_at)),console.log("Processed Test Groups:",this.testGroups)}catch(t){console.error("获取测试记录失败:",t),alert("获取测试记录失败，请稍后重试")}},formatDate(t){return new Date(t).toLocaleDateString()},exportTest(t){let e=`${t.testType} - ${this.formatDate(t.testDate)}

`;e+=`得分: ${t.score}

`,t.responses.forEach(n=>{e+=`问题: ${n.questionText||n.question_text}
`,e+=`回答: ${n.answer||n.answer_text}

`});const r=new Blob([e],{type:"text/plain"}),l=URL.createObjectURL(r),o=document.createElement("a");o.href=l,o.download=`${t.testType}_${this.formatDate(t.testDate)}.txt`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(l)},diagnoseTest(t){let e=`${t.testType} - ${this.formatDate(t.testDate)}

`;e+=`得分: ${t.score}

`,t.responses.forEach(o=>{e+=`问题: ${o.questionText||o.question_text}
`,e+=`回答: ${o.answer||o.answer_text}

`});const r=new Blob([e],{type:"text/plain"}),l=new FileReader;l.onload=()=>{localStorage.setItem("diagnosisFile",l.result),this.$router.push({name:"ai-analysis",query:{fileName:`${t.testType}_${this.formatDate(t.testDate)}.txt`}})},l.readAsDataURL(r)},goBack(){this.$router.go(-2)},viewDetails(t){const e=document.createElement("div");e.className="test-details-modal",e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100%",e.style.height="100%",e.style.backgroundColor="rgba(0,0,0,0.5)",e.style.display="flex",e.style.justifyContent="center",e.style.alignItems="center",e.style.zIndex="1000";const r=document.createElement("div");r.className="test-details-content",r.style.backgroundColor="white",r.style.padding="20px",r.style.borderRadius="8px",r.style.maxWidth="800px",r.style.maxHeight="80vh",r.style.overflowY="auto";const l=document.createElement("h2");l.textContent=`${t.testType} - ${t.testDate?this.formatDate(t.testDate):"无日期"}`,r.appendChild(l);const o=document.createElement("div");o.className="questions-container",t.responses.forEach(u=>{const a=document.createElement("div");a.style.marginBottom="15px",a.style.paddingBottom="15px",a.style.borderBottom="1px solid #eee";const i=document.createElement("p");i.style.fontWeight="bold",i.textContent=u.questionText||u.question_text||`问题 ${u.question_id}`,a.appendChild(i);const m=document.createElement("p");m.textContent=`回答: ${u.answer||u.answer_text||"无"}`,a.appendChild(m),o.appendChild(a)}),r.appendChild(o);const n=document.createElement("button");n.textContent="关闭",n.style.marginTop="20px",n.style.padding="8px 16px",n.style.backgroundColor="#4CAF50",n.style.color="white",n.style.border="none",n.style.borderRadius="4px",n.style.cursor="pointer",n.onclick=()=>document.body.removeChild(e),r.appendChild(n),e.appendChild(r),document.body.appendChild(e)}}},U={class:"customer-center"},G={class:"user-card"},$={key:0,class:"user-info"},R={class:"test-records"},I={class:"table-container"},B=["onClick"],E={colspan:"4",class:"group-title"},S={class:"expand-text"},P=["onClick"],L=["onClick"],A=["onClick"];function N(t,e,r,l,o,n){return _(),x("div",U,[s("button",{class:"back-button",onClick:e[0]||(e[0]=(...u)=>n.goBack&&n.goBack(...u))},"← 返回"),s("div",G,[e[5]||(e[5]=s("h2",null,"用户信息",-1)),o.currentUser?(_(),x("div",$,[s("div",null,[e[1]||(e[1]=s("strong",null,"姓名:",-1)),g(" "+p(o.currentUser.name),1)]),s("div",null,[e[2]||(e[2]=s("strong",null,"性别:",-1)),g(" "+p(o.currentUser.gender),1)]),s("div",null,[e[3]||(e[3]=s("strong",null,"年龄:",-1)),g(" "+p(o.currentUser.age),1)]),s("div",null,[e[4]||(e[4]=s("strong",null,"住院号:",-1)),g(" "+p(o.currentUser.hospitalNumber),1)])])):q("",!0)]),s("div",R,[e[7]||(e[7]=s("h2",null,"测试记录",-1)),s("div",I,[s("table",null,[e[6]||(e[6]=s("thead",null,[s("tr",null,[s("th",null,"测试类型"),s("th",null,"测试日期"),s("th",null,"测试次数"),s("th",null,"操作")])],-1)),s("tbody",null,[(_(!0),x(b,null,f(n.groupedTests,(u,a)=>(_(),x(b,{key:a},[s("tr",{class:"group-header",onClick:i=>n.toggleGroup(a)},[s("td",E,[g(p(a)+" ("+p(u.length)+"次) ",1),s("span",S,p(o.expandedGroups[a]?"收起":"展开"),1)])],8,B),(_(!0),x(b,null,f(u,(i,m)=>v((_(),x("tr",{key:m},[s("td",null,p(i.testType),1),s("td",null,p(n.formatDate(i.testDate)),1),s("td",null,p(i.questionCount)+"题",1),s("td",null,[s("button",{onClick:y=>n.viewDetails(i)},"查看详情",8,P),s("button",{onClick:y=>n.exportTest(i),class:"export-btn"},"导出",8,L),s("button",{onClick:y=>n.diagnoseTest(i),class:"diagnose-btn"},"诊断",8,A)])])),[[T,o.expandedGroups[a]]])),128))],64))),128))])])])])])}const F=w(k,[["render",N],["__scopeId","data-v-be662d82"]]);export{F as default};
