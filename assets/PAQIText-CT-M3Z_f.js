import{_ as O,c as l,e as p,a as s,t as h,F as V,f as S,w as m,g as _,v as k,h as b,r as U,d as N,u as j,o as i}from"./index-C23T03Zw.js";const A={name:"PAQIText",setup(){const f=j(),t=U(JSON.parse(localStorage.getItem("currentUser"))||null),y=U([]),e=U({}),g=U(!1),x=U(!1),C=U(""),n=async()=>{try{g.value=!0;const c=await(await fetch("http://172.22.104.102:8080/psqi/questions")).json();if(c.success)console.log("获取到的PSQI问题数据:",c.data),y.value=c.data.map(d=>({id:d.id,text:d.text,type:d.type||"radio",options:d.options||[],subQuestions:(d.subQuestions||[]).map(a=>({id:a.id,text:a.text,type:a.type||"radio",options:a.options||[]}))})),console.log("格式化后的PSQI问题:",y.value);else throw new Error(c.message||"获取问题失败")}catch(r){console.error("获取问题失败:",r),alert("获取问题失败，请稍后重试")}finally{g.value=!1}},I=()=>{for(const r of y.value){if(e.value[r.id]===void 0||e.value[r.id]==="")return!1;for(const c of r.subQuestions||[])if(e.value[c.id]===void 0||e.value[c.id]==="")return!1}return!0},o=async()=>{try{if(!I()){alert("请完成所有必填问题");return}g.value=!0;const r={created_at:new Date().toISOString(),hospitalInfo:{hospitalId:t.value.hospitalNumber,patientName:t.value.name},answers:Object.entries(e.value).filter(([,a])=>a!==void 0&&a!=="").map(([a,v])=>a.endsWith("_other")?{question_id:parseInt(a.split("_")[0]),answer_value:`其他: ${String(v)}`}:a==="15"?{question_id:parseInt(a),answer_value:String(v)==="1"?"是":"否"}:{question_id:parseInt(a),answer_value:String(v)}).concat(Object.entries(e.value).filter(([a])=>a.endsWith("_other")&&a.includes("sq")).map(([a,v])=>({question_id:parseInt(a.split("_")[0]),answer_value:`其他: ${String(v)}`}))).concat(Object.entries(e.value).filter(([a,v])=>a==="15"&&v!==void 0).map(([a,v])=>({question_id:parseInt(a),answer_value:String(v)==="1"?"是":"否"})))},d=await(await fetch("http://172.22.104.102:8080/psqi/responses",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(r)})).json();if(d.success)x.value=!0,C.value=d.response_id;else throw new Error(d.message||"提交失败")}catch(r){console.error("提交失败:",r),alert("提交失败，请稍后重试")}finally{g.value=!1}},u=(r,c)=>{c==="0"?e.value[`${r}_other`]="无":e.value[`${r}_other`]="",e.value[r]=c},w=()=>{f.go(-2)};return N(()=>{if(!t.value){f.push("/login");return}n().then(()=>{console.log("All questions loaded:",y.value),y.value.forEach((r,c)=>{console.log(`Question ${c+1}:`,r),r.subQuestions&&(console.log(`Subquestions for Q${c+1}:`,r.subQuestions),r.id===5&&(console.log("Detailed subquestions for Q5:"),r.subQuestions.forEach((d,a)=>{console.log(`  Subquestion ${a+1}:`,{id:d.id,text:d.text,type:d.type,options:d.options,isJQuestion:d.id===15}),d.id===15&&console.log("  J Question Details:",JSON.parse(JSON.stringify(d)))})))})})}),{currentUser:t,questions:y,answers:e,loading:g,submitted:x,responseId:C,submitAnswers:o,goBack:w,handleOtherChoiceChange:u}}},q={class:"psqi-container"},B={key:0,class:"user-info"},D={key:1},J={key:0,class:"time-input"},P=["onUpdate:modelValue"],T={key:1,class:"options"},E=["name","value","onUpdate:modelValue"],M={key:0,class:"sub-question"},F={key:0,class:"time-input"},R=["onUpdate:modelValue"],W={key:1,class:"options"},L=["name","value","onUpdate:modelValue"],z={key:1,class:"j-question"},G={class:"options"},H=["name","onUpdate:modelValue","onChange"],K=["name","onUpdate:modelValue","onChange"],Q={key:0,class:"text-input"},X=["onUpdate:modelValue"],Y={key:0,class:"j-question"},Z={class:"options"},$={key:0,class:"text-input"},ee={key:2,class:"loading"},te={key:3,class:"result"};function ne(f,t,y,e,g,x){var C;return i(),l("div",q,[e.currentUser?(i(),l("div",B,[s("h3",null,"当前用户: "+h(e.currentUser.name),1),s("p",null,"病历号: "+h(e.currentUser.hospitalNumber),1)])):p("",!0),!e.submitted&&e.questions.length>0?(i(),l("div",D,[t[11]||(t[11]=s("h2",null,"匹兹堡睡眠质量指数(PSQI)测试",-1)),(i(!0),l(V,null,S(e.questions,(n,I)=>(i(),l("div",{key:n.id,class:"question-section"},[s("h3",null,h(I+1)+". "+h(n.text),1),n&&n.type==="time"?(i(),l("div",J,[m(s("input",{type:"time","onUpdate:modelValue":o=>e.answers[n.id]=o,required:""},null,8,P),[[b,e.answers[n.id]]])])):p("",!0),n.type==="option"?(i(),l("div",T,[(i(!0),l(V,null,S(n.options,(o,u)=>(i(),l("label",{key:u},[m(s("input",{type:"radio",name:"q"+n.id,value:u,"onUpdate:modelValue":w=>e.answers[n.id]=w,required:""},null,8,E),[[k,e.answers[n.id]]]),_(" "+h(o),1)]))),128))])):p("",!0),n.subQuestions?(i(!0),l(V,{key:2},S(n.subQuestions,o=>(i(),l(V,{key:o.id},[o.id!==15?(i(),l("div",M,[s("p",null,h(o.text),1),o.type==="time"?(i(),l("div",F,[m(s("input",{type:"time","onUpdate:modelValue":u=>e.answers[o.id]=u,required:""},null,8,R),[[b,e.answers[o.id]]])])):p("",!0),o.type==="option"?(i(),l("div",W,[(i(!0),l(V,null,S(o.options,(u,w)=>(i(),l("label",{key:w},[m(s("input",{type:"radio",name:"sq"+o.id,value:w,"onUpdate:modelValue":r=>e.answers[o.id]=r,required:""},null,8,L),[[k,e.answers[o.id]]]),_(" "+h(u),1)]))),128))])):p("",!0)])):(i(),l("div",z,[s("h3",null,h(o.text),1),s("div",G,[s("label",null,[m(s("input",{type:"radio",name:"sq"+o.id,value:"1","onUpdate:modelValue":u=>e.answers[o.id]=u,required:"",onChange:u=>e.handleOtherChoiceChange(o.id,"1")},null,40,H),[[k,e.answers[o.id]]]),t[7]||(t[7]=_(" 是 "))]),s("label",null,[m(s("input",{type:"radio",name:"sq"+o.id,value:"0","onUpdate:modelValue":u=>e.answers[o.id]=u,required:"",onChange:u=>e.handleOtherChoiceChange(o.id,"0")},null,40,K),[[k,e.answers[o.id]]]),t[8]||(t[8]=_(" 否 "))])]),e.answers[o.id]==="1"?(i(),l("div",Q,[m(s("textarea",{"onUpdate:modelValue":u=>e.answers[o.id+"_other"]=u,placeholder:"请具体写明其他影响睡眠的事情",rows:"3",required:"",class:"other-textarea"},null,8,X),[[b,e.answers[o.id+"_other"]]])])):p("",!0)]))],64))),128)):p("",!0)]))),128)),f.question&&f.question.id===5&&f.question.subQuestions?(i(),l("div",Y,[s("h3",null,h(((C=f.question.subQuestions.find(n=>n.id===15))==null?void 0:C.text)||"j. 有无其他影响睡眠的事情？（若有请具体写明）"),1),s("div",Z,[s("label",null,[m(s("input",{type:"radio",name:"sq15",value:"1","onUpdate:modelValue":t[0]||(t[0]=n=>e.answers[15]=n),required:"",onChange:t[1]||(t[1]=n=>e.handleOtherChoiceChange(15,"1"))},null,544),[[k,e.answers[15]]]),t[9]||(t[9]=_(" 是 "))]),s("label",null,[m(s("input",{type:"radio",name:"sq15",value:"0","onUpdate:modelValue":t[2]||(t[2]=n=>e.answers[15]=n),required:"",onChange:t[3]||(t[3]=n=>e.handleOtherChoiceChange(15,"0"))},null,544),[[k,e.answers[15]]]),t[10]||(t[10]=_(" 否 "))])]),e.answers[15]==="1"?(i(),l("div",$,[m(s("textarea",{"onUpdate:modelValue":t[4]||(t[4]=n=>e.answers["15_other"]=n),placeholder:"请具体写明其他影响睡眠的事情",rows:"3",required:"",class:"other-textarea"},null,512),[[b,e.answers["15_other"]]])])):p("",!0)])):p("",!0),s("button",{onClick:t[5]||(t[5]=(...n)=>e.submitAnswers&&e.submitAnswers(...n)),class:"submit-btn"}," 提交测试 ")])):p("",!0),e.loading?(i(),l("div",ee,t[12]||(t[12]=[s("p",null,"加载中...",-1)]))):p("",!0),e.submitted?(i(),l("div",te,[t[13]||(t[13]=s("h3",null,"测试提交成功！",-1)),s("p",null,"您的测试ID: "+h(e.responseId),1),s("button",{onClick:t[6]||(t[6]=(...n)=>e.goBack&&e.goBack(...n)),class:"back-btn"},"返回")])):p("",!0)])}const se=O(A,[["render",ne],["__scopeId","data-v-610905f4"]]);export{se as default};
